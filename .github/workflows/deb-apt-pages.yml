name: Build .deb and Publish APT repo (GitHub Pages)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deb-and-publish-apt:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system deps (build + APT tooling)
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gzip \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-util1 \
            libxcb-xkb1 \
            libxcb-cursor0

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build binary (PyInstaller)
        run: |
          # Ajusta --name si tu binario debe llamarse distinto
          pyinstaller --noconfirm --clean --name office-files-cypher src/main.py

      - name: Build .deb
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME#v}"
          APPNAME="office-files-cypher"

          BIN_SRC="dist/${APPNAME}"
          test -f "${BIN_SRC}"

          PKGROOT="pkgroot"
          rm -rf "${PKGROOT}"
          mkdir -p "${PKGROOT}/DEBIAN"
          mkdir -p "${PKGROOT}/usr/bin"
          mkdir -p "${PKGROOT}/usr/share/applications"
          mkdir -p "${PKGROOT}/usr/share/icons/hicolor/256x256/apps"

          install -m 0755 "${BIN_SRC}" "${PKGROOT}/usr/bin/${APPNAME}"

          install -m 0644 packaging/linux/Office_files_Cypher.desktop \
            "${PKGROOT}/usr/share/applications/${APPNAME}.desktop"

          install -m 0644 packaging/linux/office_files_cypher.png \
            "${PKGROOT}/usr/share/icons/hicolor/256x256/apps/${APPNAME}.png"

          # control sin heredoc
          {
            echo "Package: ${APPNAME}"
            echo "Version: ${VERSION}"
            echo "Section: utils"
            echo "Priority: optional"
            echo "Architecture: amd64"
            echo "Maintainer: Mikehenrytech <noreply@github.com>"
            echo "Depends: libc6 (>= 2.35)"
            echo "Description: Office Files Cypher - Encrypt PDF, Word, Excel and PowerPoint files in batch (GUI)"
          } > "${PKGROOT}/DEBIAN/control"

          # postinst sin heredoc
          printf '%s\n' \
            '#!/bin/sh' \
            'set -e' \
            'if command -v update-desktop-database >/dev/null 2>&1; then' \
            '  update-desktop-database -q || true' \
            'fi' \
            'if command -v gtk-update-icon-cache >/dev/null 2>&1; then' \
            '  gtk-update-icon-cache -q /usr/share/icons/hicolor || true' \
            'fi' \
            'exit 0' \
            > "${PKGROOT}/DEBIAN/postinst"
          chmod 0755 "${PKGROOT}/DEBIAN/postinst"

          DEB_NAME="${APPNAME}_${VERSION}_amd64.deb"
          dpkg-deb --build "${PKGROOT}" "${DEB_NAME}"

          mkdir -p release
          mv "${DEB_NAME}" release/

      - name: Upload artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: deb-amd64
          path: release/*.deb

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Publish APT repo into gh-pages
        shell: bash
        run: |
          set -euo pipefail

          APPNAME="office-files-cypher"
          VERSION="${GITHUB_REF_NAME#v}"
          DEB="../release/${APPNAME}_${VERSION}_amd64.deb"
          test -f "${DEB}"

          cd gh-pages

          mkdir -p apt/pool
          mkdir -p apt/dists/stable/main/binary-amd64

          cp -f "${DEB}" "apt/pool/"

          cd apt

          dpkg-scanpackages --multiversion pool /dev/null > dists/stable/main/binary-amd64/Packages
          gzip -fk dists/stable/main/binary-amd64/Packages

          # Release base sin heredoc
          RELEASE_FILE="dists/stable/Release"
          {
            echo "Origin: Mikehenrytech"
            echo "Label: PDF Cypher APT Repo"
            echo "Suite: stable"
            echo "Codename: stable"
            echo "Architectures: amd64"
            echo "Components: main"
            echo "Description: APT repository for PDF Cypher"
          } > "${RELEASE_FILE}"

          # AÃ±adir hashes (sin heredoc): generamos con bash puro
          cd dists/stable

          echo "MD5Sum:" >> Release
          while IFS= read -r f; do
            size="$(stat -c%s "$f")"
            sum="$(md5sum "$f" | awk '{print $1}')"
            printf " %s %16d %s\n" "$sum" "$size" "$f" >> Release
          done < <(find . -type f ! -name Release -printf "%P\n" | sort)

          echo "SHA256:" >> Release
          while IFS= read -r f; do
            size="$(stat -c%s "$f")"
            sum="$(sha256sum "$f" | awk '{print $1}')"
            printf " %s %16d %s\n" "$sum" "$size" "$f" >> Release
          done < <(find . -type f ! -name Release -printf "%P\n" | sort)

      - name: Commit and push gh-pages
        shell: bash
        run: |
          set -euo pipefail
          cd gh-pages

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add apt
          git commit -m "apt: publish ${GITHUB_REF_NAME}" || echo "No changes to commit"
          git push

