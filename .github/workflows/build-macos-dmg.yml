name: Build macOS DMG and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  macos:
    name: Build macOS (.app + .dmg) and Release
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build (.app) with PyInstaller
        run: |
          set -eux
          pyinstaller --noconfirm --clean --windowed \
            --name Office_files_Cypher \
            --add-data "i18n:i18n" \
            src/main.py

      - name: Package (.app) into zip
        run: |
          set -eux
          mkdir -p release
          ditto -c -k --sequesterRsrc --keepParent "dist/Office_files_Cypher.app" "release/Office_files_Cypher-macos.app.zip"
          ls -lh release

      - name: Create DMG (unsigned) with hdiutil
        run: |
          set -eux
          mkdir -p release dmgroot

          # Prepara estructura del DMG
          rm -rf dmgroot/*
          cp -R "dist/Office_files_Cypher.app" dmgroot/

          # (Opcional) Symlink a /Applications para UX drag & drop
          ln -s /Applications dmgroot/Applications

          # Crea DMG comprimido (read-only)
          hdiutil create \
            -volname "Office_files_Cypher" \
            -srcfolder "dmgroot" \
            -ov \
            -format UDZO \
            "release/Office_files_Cypher-macos.dmg"

          ls -lh release

      - name: Upload build artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: Office_files_Cypher-macos
          path: |
            release/Office_files_Cypher-macos.app.zip
            release/Office_files_Cypher-macos.dmg

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/Office_files_Cypher-macos.app.zip
            release/Office_files_Cypher-macos.dmg
